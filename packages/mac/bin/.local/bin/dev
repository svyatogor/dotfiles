#!/usr/bin/env bash
function devcontainer_root() {
  local dir=$PWD
  while [ "$dir" != "/" ]; do
    if [[ -f "$dir/.devcontainer.json" ]] || [[ -d "$dir/.devcontainer" ]]; then
      echo $dir
      return
    fi
    dir=$(dirname "$dir")
  done
  echo "No .devcontainer.json or .devcontainer/ found" >&2
  return 1
}

function get_container_id() {
  docker ps -q --filter label=devcontainer.local_folder=$root
}

function get_workspace_folder() {
  local devcontainer_config=""
  if [[ -f "$root/.devcontainer.json" ]]; then
    devcontainer_config="$root/.devcontainer.json"
  elif [[ -f "$root/.devcontainer/devcontainer.json" ]]; then
    devcontainer_config="$root/.devcontainer/devcontainer.json"
  else
    echo "/workspaces"
    return
  fi

  local workspace_folder=$(cat "$devcontainer_config" | sed 's/^ *\/\/.*//' | jq -r '.workspaceFolder // "/workspaces"')
  echo "$workspace_folder"
}

# Parse arguments using getopt
# only “--up”
UP_FLAG=0
COMMAND_ARGS=""

while getopts "u" opt; do
  case "$opt" in
  u) UP_FLAG=1 ;;
  *)
    echo "Usage: $0 [-u]" >&2
    exit 1
    ;;
  esac
done
shift $((OPTIND - 1))

root=$(devcontainer_root)
if [ "$root" = "" ]; then
  echo "No .devcontainer.json or .devcontainer/ found" >&2
  return 1
fi

if [ $UP_FLAG -eq 1 ]; then
  user=$(cat "$root/.devcontainer/devcontainer.json" | sed 's/^ *\/\/.*//' | jq -r '.containerUser')
  devcontainer up \
    --remote-env SSH_AUTH_SOCK=/ssh.sock \
    --mount "type=bind,source=/run/host-services/ssh-auth.sock,target=/ssh.sock" \
    --mount "type=volume,source=shell-history,target=/home/$user/.local/share" \
    --dotfiles-repository https://github.com/svyatogor/dotfiles.git \
    --dotfiles-install-command scripts/setup-devcontainer.sh \
    --workspace-folder $root \
    --additional-features '{"ghcr.io/devcontainers/features/sshd:1": {}, "ghcr.io/devcontainers-extra/features/apt-packages:1": {"packages": "tmux stow "}, "ghcr.io/roul/devcontainer-features/mise:1": {}}' \
    --remove-existing-container
else
  container_id=$(get_container_id)
  workspace_folder=$(get_workspace_folder)

  # Build environment variables
  ENV_VARS="-e PROFILE=devcontainer -e SSH_AUTH_SOCK=/ssh.sock -e DEV_CONTAINER_NAME=$(basename $root) -e TERM  -e AWS_PROFILE -e AWS_DEFAULT_REGION -e AWS_REGION -e AWS_SESSION_EXPIRATION -e AWS_SECRET_ACCESS_KEY -e AWS_ACCESS_KEY_ID -e AWS_CREDENTIAL_EXPIRATION -e AWS_SESSION_TOKEN"

  if [ -z "$COMMAND_ARGS" ]; then
    # op run --no-masking --env-file="$HOME/dotfiles/container-secrets.env" -- $DOCKER exec $ENV_VARS -w /workspace -it $container_id fish -ilc "tmux new -A -s $(basename $root)"
    op run --no-masking -- docker exec $ENV_VARS -w "$workspace_folder" -it $container_id bash -il
  else
    op run --no-masking -- docker exec $ENV_VARS -w "$workspace_folder" -it $container_id bash -ilc "$COMMAND_ARGS"
  fi
fi
